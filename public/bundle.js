class e{constructor(e={}){this.id=e.id||"agent",this.name=e.name||"Agent",this.capabilities=e.capabilities||[],this.messageHandlers=new Map,this.metrics={},this.startTime=Date.now(),this.logger=console}async initialize(){this.logger.info(`Initializing agent: ${this.name}`)}async registerCapabilities(e){this.capabilities=[...this.capabilities,...e]}onMessage(e,t){this.messageHandlers.set(e,t)}async handleMessage(e){const t=this.messageHandlers.get(e.type);return t?await t(e):{success:!1,error:"Unknown message type"}}async sendMessage(e,t){return{success:!0}}async healthCheck(){return{status:"healthy",uptime:Date.now()-this.startTime}}async shutdown(){this.logger.info(`Shutting down agent: ${this.name}`)}}class t{constructor(e={}){this.id=e.id||"orchestrator",this.name=e.name||"Orchestrator",this.agents=new Map,this.logger=console}async initialize(){this.logger.info("Initializing orchestrator")}async shutdown(){this.logger.info("Shutting down orchestrator")}}class s{constructor(){this.grid=this.createEmptyGrid(),this.currentPiece=null,this.nextPieces=[],this.score=0,this.level=1,this.lines=0,this.gameState="playing",this.dropTimer=0,this.dropInterval=1e3}createEmptyGrid(){return Array(20).fill().map(()=>Array(10).fill(0))}spawnNewPiece(){return 0===this.nextPieces.length&&this.generateNextPieces(),this.currentPiece=this.nextPieces.shift(),this.currentPiece.x=4,this.currentPiece.y=0,this.checkCollision(this.currentPiece,this.currentPiece.x,this.currentPiece.y)?(this.gameState="gameOver",!1):(this.generateNextPieces(),!0)}generateNextPieces(){const e=["I","O","T","S","Z","J","L"];for(;this.nextPieces.length<3;){const t=e[Math.floor(Math.random()*e.length)];this.nextPieces.push(new i(t))}}checkCollision(e,t,s){const i=e.getShape();for(let e=0;e<i.length;e++)for(let a=0;a<i[e].length;a++){if(0===i[e][a])continue;const n=t+a,r=s+e;if(n<0||n>=10||r>=20)return!0;if(!(r<0)&&0!==this.grid[r][n])return!0}return!1}movePiece(e){if(!this.currentPiece||"playing"!==this.gameState)return!1;let t=this.currentPiece.x,s=this.currentPiece.y;switch(e){case"left":t--;break;case"right":t++;break;case"down":s++}return this.checkCollision(this.currentPiece,t,s)?("down"===e&&this.lockPiece(),!1):(this.currentPiece.x=t,this.currentPiece.y=s,!0)}rotatePiece(){if(!this.currentPiece||"playing"!==this.gameState)return!1;const e=this.currentPiece.rotation;this.currentPiece.rotate();const t=this.getWallKicks(this.currentPiece.type,e);for(const e of t){const t=this.currentPiece.x+e.x,s=this.currentPiece.y+e.y;if(!this.checkCollision(this.currentPiece,t,s))return this.currentPiece.x=t,this.currentPiece.y=s,!0}return this.currentPiece.rotation=e,!1}getWallKicks(e,t){return{JLSTZ:[[{x:0,y:0},{x:-1,y:0},{x:-1,y:1},{x:0,y:-2},{x:-1,y:-2}],[{x:0,y:0},{x:1,y:0},{x:1,y:-1},{x:0,y:2},{x:1,y:2}],[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:1,y:-2}],[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:0,y:2},{x:-1,y:2}]],I:[[{x:0,y:0},{x:-2,y:0},{x:1,y:0},{x:-2,y:-1},{x:1,y:2}],[{x:0,y:0},{x:-1,y:0},{x:2,y:0},{x:-1,y:2},{x:2,y:-1}],[{x:0,y:0},{x:2,y:0},{x:-1,y:0},{x:2,y:1},{x:-1,y:-2}],[{x:0,y:0},{x:1,y:0},{x:-2,y:0},{x:1,y:-2},{x:-2,y:1}]]}["I"===e?"I":"JLSTZ"][t]||[{x:0,y:0}]}lockPiece(){const e=this.currentPiece.getShape();for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++)if(0!==e[t][s]){const e=this.currentPiece.x+s,i=this.currentPiece.y+t;i>=0&&(this.grid[i][e]=this.currentPiece.type)}const t=this.clearLines();this.updateScore(t),this.spawnNewPiece()}clearLines(){let e=0,t=19;for(let s=19;s>=0;s--)this.isLineFull(s)?e++:(t!==s&&(this.grid[t]=[...this.grid[s]]),t--);for(let e=0;e<=t;e++)this.grid[e]=new Array(10).fill(0);return e}isLineFull(e){return this.grid[e].every(e=>0!==e)}updateScore(e){if(e>0){const t=[0,40,100,300,1200][e]*this.level;this.score+=t,this.lines+=e;const s=Math.floor(this.lines/10)+1;s>this.level&&(this.level=s,this.dropInterval=Math.max(50,1e3-50*(this.level-1)))}}update(e){"playing"===this.gameState&&(this.dropTimer+=e,this.dropTimer>=this.dropInterval&&(this.movePiece("down"),this.dropTimer=0))}getGrid(){return this.grid.map(e=>[...e])}getState(){return{grid:this.grid.map(e=>[...e]),currentPiece:this.currentPiece?{type:this.currentPiece.type,x:this.currentPiece.x,y:this.currentPiece.y,rotation:this.currentPiece.rotation,shape:this.currentPiece.getShape()}:null,nextPieces:this.nextPieces.map(e=>({type:e.type,shape:e.getShape()})),score:this.score,level:this.level,lines:this.lines,gameState:this.gameState}}}class i{constructor(e){this.type=e,this.x=0,this.y=0,this.rotation=0,this.shapes=this.getShapes()}getShapes(){return{I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],O:[[[1,1],[1,1]],[[1,1],[1,1]],[[1,1],[1,1]],[[1,1],[1,1]]],T:[[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]],S:[[[0,1,1],[1,1,0],[0,0,0]],[[0,1,0],[0,1,1],[0,0,1]],[[0,0,0],[0,1,1],[1,1,0]],[[1,0,0],[1,1,0],[0,1,0]]],Z:[[[1,1,0],[0,1,1],[0,0,0]],[[0,0,1],[0,1,1],[0,1,0]],[[0,0,0],[1,1,0],[0,1,1]],[[0,1,0],[1,1,0],[1,0,0]]],J:[[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]],L:[[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]]}[this.type]}getShape(){return this.shapes[this.rotation]}rotate(){this.rotation=(this.rotation+1)%4}}class a extends e{constructor(e={}){super({id:"game-engine",name:"Tetris Game Engine",capabilities:["game-logic","state-management","collision-detection"],...e}),this.gameEngine=new s,this.gameState="initialized",this.subscribers=new Set,this.setupMessageHandlers()}async initialize(){await super.initialize(),this.logger.info("Game Engine Agent initialized"),await this.registerCapabilities(["game-logic","state-management","collision-detection","piece-movement","line-clearing"]),this.gameState="ready"}setupMessageHandlers(){this.onMessage("START_GAME",this.handleStartGame.bind(this)),this.onMessage("PAUSE_GAME",this.handlePauseGame.bind(this)),this.onMessage("RESTART_GAME",this.handleRestartGame.bind(this)),this.onMessage("MOVE_PIECE",this.handleMovePiece.bind(this)),this.onMessage("ROTATE_PIECE",this.handleRotatePiece.bind(this)),this.onMessage("DROP_PIECE",this.handleDropPiece.bind(this)),this.onMessage("GET_GAME_STATE",this.handleGetGameState.bind(this)),this.onMessage("GET_GRID",this.handleGetGrid.bind(this)),this.onMessage("GET_CURRENT_PIECE",this.handleGetCurrentPiece.bind(this)),this.onMessage("SUBSCRIBE_STATE_UPDATES",this.handleSubscribeStateUpdates.bind(this)),this.onMessage("UNSUBSCRIBE_STATE_UPDATES",this.handleUnsubscribeStateUpdates.bind(this))}async handleStartGame(e){try{return this.gameEngine=new s,this.gameEngine.spawnNewPiece(),this.gameState="playing",this.logger.info("Game started"),await this.broadcastStateUpdate("GAME_STARTED"),{success:!0,gameState:this.gameEngine.getState()}}catch(e){return this.logger.error("Failed to start game:",e),{success:!1,error:e.message}}}async handlePauseGame(e){try{return"playing"===this.gameEngine.gameState?(this.gameEngine.gameState="paused",this.gameState="paused"):"paused"===this.gameEngine.gameState&&(this.gameEngine.gameState="playing",this.gameState="playing"),await this.broadcastStateUpdate("GAME_PAUSED"),{success:!0,gameState:this.gameEngine.gameState}}catch(e){return this.logger.error("Failed to pause/resume game:",e),{success:!1,error:e.message}}}async handleRestartGame(e){try{return this.gameEngine=new s,this.gameEngine.spawnNewPiece(),this.gameState="playing",await this.broadcastStateUpdate("GAME_RESTARTED"),{success:!0,gameState:this.gameEngine.getState()}}catch(e){return this.logger.error("Failed to restart game:",e),{success:!1,error:e.message}}}async handleMovePiece(e){const t=performance.now();try{const{direction:s}=e.payload;if(!["left","right","down"].includes(s))throw new Error(`Invalid direction: ${s}`);const i=this.gameEngine.movePiece(s),a=performance.now();return this.recordMetric("move_latency",a-t),i?await this.broadcastStateUpdate("PIECE_MOVED",{direction:s}):"down"===s&&await this.broadcastStateUpdate("PIECE_LOCKED"),{success:!0,moved:i,gameState:this.gameEngine.getState()}}catch(e){return this.logger.error("Failed to move piece:",e),{success:!1,error:e.message}}}async handleRotatePiece(e){const t=performance.now();try{const e=this.gameEngine.rotatePiece(),s=performance.now();return this.recordMetric("rotate_latency",s-t),e&&await this.broadcastStateUpdate("PIECE_ROTATED"),{success:!0,rotated:e,gameState:this.gameEngine.getState()}}catch(e){return this.logger.error("Failed to rotate piece:",e),{success:!1,error:e.message}}}async handleDropPiece(e){try{let e=0;for(;this.gameEngine.movePiece("down");)e++;return this.gameEngine.score+=2*e,await this.broadcastStateUpdate("PIECE_DROPPED",{dropDistance:e}),{success:!0,dropDistance:e,gameState:this.gameEngine.getState()}}catch(e){return this.logger.error("Failed to drop piece:",e),{success:!1,error:e.message}}}async handleGetGameState(e){return{success:!0,gameState:this.gameEngine.getState()}}async handleGetGrid(e){return{success:!0,grid:this.gameEngine.grid.map(e=>[...e])}}async handleGetCurrentPiece(e){const t=this.gameEngine.currentPiece;return{success:!0,currentPiece:t?{type:t.type,x:t.x,y:t.y,rotation:t.rotation,shape:t.getShape()}:null}}async handleSubscribeStateUpdates(e){const{agentId:t}=e.payload;return this.subscribers.add(t),this.logger.info(`Agent ${t} subscribed to state updates`),{success:!0}}async handleUnsubscribeStateUpdates(e){const{agentId:t}=e.payload;return this.subscribers.delete(t),this.logger.info(`Agent ${t} unsubscribed from state updates`),{success:!0}}async broadcastStateUpdate(e,t={}){const s={type:"GAME_STATE_UPDATE",payload:{eventType:e,eventData:t,gameState:this.gameEngine.getState(),timestamp:Date.now()}},i=Array.from(this.subscribers).map(e=>this.sendMessage(e,s).catch(t=>this.logger.warn(`Failed to notify ${e}:`,t)));await Promise.allSettled(i)}async update(e){if("playing"===this.gameEngine.gameState){const t=this.gameEngine.getState();this.gameEngine.update(e);const s=this.gameEngine.getState();this.hasSignificantStateChange(t,s)&&await this.broadcastStateUpdate("GAME_TICK"),"gameOver"===s.gameState&&"gameOver"!==t.gameState&&await this.broadcastStateUpdate("GAME_OVER")}}hasSignificantStateChange(e,t){return e.score!==t.score||e.level!==t.level||e.lines!==t.lines||e.gameState!==t.gameState}recordMetric(e,t){this.metrics=this.metrics||{},this.metrics[e]=this.metrics[e]||[],this.metrics[e].push({value:t,timestamp:Date.now()}),this.metrics[e].length>100&&(this.metrics[e]=this.metrics[e].slice(-100))}getPerformanceMetrics(){const e={};for(const[t,s]of Object.entries(this.metrics||{})){const i=s.slice(-50).map(e=>e.value);e[t]={count:i.length,avg:i.reduce((e,t)=>e+t,0)/i.length,min:Math.min(...i),max:Math.max(...i),p95:this.percentile(i,.95)}}return e}percentile(e,t){const s=[...e].sort((e,t)=>e-t);return s[Math.ceil(s.length*t)-1]||0}async healthCheck(){const e=this.getPerformanceMetrics(),t=[];return e.move_latency?.avg>1&&t.push("High move latency"),e.rotate_latency?.avg>1&&t.push("High rotation latency"),{status:0===t.length?"healthy":"degraded",issues:t,metrics:e,gameState:this.gameState,uptime:Date.now()-this.startTime}}async shutdown(){this.logger.info("Shutting down Game Engine Agent"),await this.broadcastStateUpdate("AGENT_SHUTDOWN"),this.subscribers.clear(),await super.shutdown()}}class n extends e{constructor(e={}){super({id:"ai-predictor",name:"Tetris AI Predictor",capabilities:["move-prediction","board-analysis","difficulty-adaptation"],...e}),this.difficultyLevel=1,this.predictionCache=new Map,this.heuristicWeights={height:-.510066,lines:.760666,holes:-.35663,bumpiness:-.184483},this.setupMessageHandlers()}async initialize(){await super.initialize(),this.logger.info("AI Predictor Agent initialized"),await this.registerCapabilities(["move-prediction","board-analysis","placement-scoring","lookahead-calculation","difficulty-adaptation"]),await this.loadAIModel()}setupMessageHandlers(){this.onMessage("PREDICT_BEST_MOVE",this.handlePredictBestMove.bind(this)),this.onMessage("ANALYZE_BOARD",this.handleAnalyzeBoard.bind(this)),this.onMessage("SCORE_PLACEMENT",this.handleScorePlacement.bind(this)),this.onMessage("CALCULATE_LOOKAHEAD",this.handleCalculateLookahead.bind(this)),this.onMessage("SET_DIFFICULTY",this.handleSetDifficulty.bind(this)),this.onMessage("UPDATE_WEIGHTS",this.handleUpdateWeights.bind(this)),this.onMessage("GAME_STATE_UPDATE",this.handleGameStateUpdate.bind(this))}async loadAIModel(){try{("undefined"!=typeof process&&process.env?process.env.AI_MODEL_CONFIG:null)&&this.logger.info("Loading AI model configuration"),this.aiModelLoaded=!0}catch(e){this.logger.warn("Failed to load AI model, using heuristics:",e),this.aiModelLoaded=!1}}async handlePredictBestMove(e){const t=performance.now();try{const{piece:s,grid:i,nextPieces:a=[]}=e.payload,n=this.generateCacheKey(s,i);if(this.predictionCache.has(n))return{success:!0,prediction:this.predictionCache.get(n),cached:!0,processingTime:performance.now()-t};const r=this.generatePossibleMoves(s,i),o=await Promise.all(r.map(async e=>({...e,score:await this.scorePlacement(s,e,i,a)})));o.sort((e,t)=>t.score-e.score);const c=o[0],h={move:c,confidence:this.calculateConfidence(o),alternatives:o.slice(1,4),reasoning:this.generateReasoning(c,i)};this.predictionCache.set(n,h),this.cleanupCache();const l=performance.now()-t;return this.recordMetric("prediction_time",l),{success:!0,prediction:h,processingTime:l}}catch(e){return this.logger.error("Failed to predict best move:",e),{success:!1,error:e.message}}}generatePossibleMoves(e,t){const s=[];for(let i=0;i<4;i++){const a=this.getShapeForRotation(e.type,i);for(let e=-3;e<13;e++){let n=0;for(;n<20&&!this.checkCollision(a,e,n,t);)n++;n--,n>=0&&!this.checkCollision(a,e,n,t)&&s.push({x:e,y:n,rotation:i})}}return s}async scorePlacement(e,t,s,i=[]){const a=this.placepiece(e,t,s),{clearedGrid:n,linesCleared:r}=this.clearLines(a),o=this.calculateHeuristicScore(n,r),c=this.getDifficultyAccuracy();let h=o+(Math.random()-.5)*(1-c)*.2;return i.length>0&&(h=.7*h+.3*await this.calculateLookaheadScore(n,i.slice(0,2),2)),Math.max(0,Math.min(100,h))}calculateHeuristicScore(e,t){const s=this.getAggregateHeight(e),i=this.getHoles(e),a=this.getBumpiness(e);return this.heuristicWeights.height*s+this.heuristicWeights.lines*t+this.heuristicWeights.holes*i+this.heuristicWeights.bumpiness*a}async calculateLookaheadScore(e,t,s){if(0===s||0===t.length)return this.calculateHeuristicScore(e,0);const i=t[0],a=this.generatePossibleMoves(i,e);let n=-1/0;for(const r of a.slice(0,5)){const a=this.placepiece(i,r,e),{clearedGrid:o,linesCleared:c}=this.clearLines(a),h=this.calculateHeuristicScore(o,c)+.8*await this.calculateLookaheadScore(o,t.slice(1),s-1);n=Math.max(n,h)}return n}placepiece(e,t,s){const i=s.map(e=>[...e]),a=this.getShapeForRotation(e.type,t.rotation);for(let s=0;s<a.length;s++)for(let n=0;n<a[s].length;n++)if(0!==a[s][n]){const a=t.x+n,r=t.y+s;r>=0&&r<20&&a>=0&&a<10&&(i[r][a]=e.type)}return i}clearLines(e){const t=[];let s=0;for(let i=0;i<e.length;i++)e[i].every(e=>0!==e)?s++:t.push([...e[i]]);for(;t.length<20;)t.unshift(new Array(10).fill(0));return{clearedGrid:t,linesCleared:s}}getAggregateHeight(e){let t=0;for(let s=0;s<10;s++)for(let i=0;i<20;i++)if(0!==e[i][s]){t+=20-i;break}return t}getHoles(e){let t=0;for(let s=0;s<10;s++){let i=!1;for(let a=0;a<20;a++)0!==e[a][s]?i=!0:i&&t++}return t}getBumpiness(e){const t=[];for(let s=0;s<10;s++){let i=0;for(let t=0;t<20;t++)if(0!==e[t][s]){i=20-t;break}t.push(i)}let s=0;for(let e=0;e<t.length-1;e++)s+=Math.abs(t[e]-t[e+1]);return s}checkCollision(e,t,s,i){for(let a=0;a<e.length;a++)for(let n=0;n<e[a].length;n++){if(0===e[a][n])continue;const r=t+n,o=s+a;if(r<0||r>=10||o>=20)return!0;if(!(o<0)&&0!==i[o][r])return!0}return!1}getShapeForRotation(e,t){return{I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],O:[[[1,1],[1,1]],[[1,1],[1,1]],[[1,1],[1,1]],[[1,1],[1,1]]],T:[[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]],S:[[[0,1,1],[1,1,0],[0,0,0]],[[0,1,0],[0,1,1],[0,0,1]],[[0,0,0],[0,1,1],[1,1,0]],[[1,0,0],[1,1,0],[0,1,0]]],Z:[[[1,1,0],[0,1,1],[0,0,0]],[[0,0,1],[0,1,1],[0,1,0]],[[0,0,0],[1,1,0],[0,1,1]],[[0,1,0],[1,1,0],[1,0,0]]],J:[[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]],L:[[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]]}[e][t%4]}calculateConfidence(e){if(e.length<2)return 1;const t=e[0].score-e[1].score;return Math.min(1,t/20)*this.getDifficultyAccuracy()}getDifficultyAccuracy(){return.6+.035*(this.difficultyLevel-1)}generateReasoning(e,t){const s=[];e.score>80?s.push("Excellent placement"):e.score>60?s.push("Good placement"):e.score>40?s.push("Acceptable placement"):s.push("Defensive placement");const i=this.placepiece({type:"I"},e,t),{linesCleared:a}=this.clearLines(i);a>0&&s.push(`Clears ${a} line${a>1?"s":""}`);const n=this.getHoles(i);return 0===n?s.push("Creates no holes"):n>3&&s.push("Minimizes hole creation"),s.join(", ")}generateCacheKey(e,t){const s=`${e.type}-${e.x}-${e.y}-${e.rotation}`,i=t.map(e=>e.join("")).join("");return`${s}:${this.hashString(i)}`}hashString(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t&=t;return t.toString(36)}cleanupCache(){this.predictionCache.size>1e3&&Array.from(this.predictionCache.keys()).slice(0,500).forEach(e=>this.predictionCache.delete(e))}async handleAnalyzeBoard(e){try{const{grid:t}=e.payload;return{success:!0,analysis:{height:this.getAggregateHeight(t),holes:this.getHoles(t),bumpiness:this.getBumpiness(t),dangerLevel:this.calculateDangerLevel(t),recommendations:this.generateRecommendations(t)}}}catch(e){return this.logger.error("Failed to analyze board:",e),{success:!1,error:e.message}}}calculateDangerLevel(e){const t=Math.max(...Array.from({length:10},(t,s)=>{for(let t=0;t<20;t++)if(0!==e[t][s])return 20-t;return 0}));return Math.min(1,t/15)}generateRecommendations(e){const t=[];return this.getHoles(e)>5&&t.push("Focus on clearing lines to reduce holes"),this.calculateDangerLevel(e)>.7&&t.push("Critical: Clear lines immediately"),this.getBumpiness(e)>10&&t.push("Try to even out the surface"),t}async handleScorePlacement(e){try{const{piece:t,move:s,grid:i,nextPieces:a}=e.payload;return{success:!0,score:await this.scorePlacement(t,s,i,a)}}catch(e){return{success:!1,error:e.message}}}async handleCalculateLookahead(e){try{const{pieces:t,grid:s,depth:i}=e.payload;return{success:!0,moves:await this.calculateLookaheadScore(s,t,i)}}catch(e){return{success:!1,error:e.message}}}async handleUpdateWeights(e){try{const{weights:t}=e.payload;return this.heuristicWeights={...this.heuristicWeights,...t},{success:!0,weights:this.heuristicWeights}}catch(e){return{success:!1,error:e.message}}}async handleSetDifficulty(e){const{level:t}=e.payload;return t>=1&&t<=10?(this.difficultyLevel=t,this.logger.info(`Difficulty set to level ${t}`),{success:!0,level:this.difficultyLevel}):{success:!1,error:"Invalid difficulty level"}}async handleGameStateUpdate(e){const{eventType:t,gameState:s}=e.payload;["GAME_STARTED","GAME_RESTARTED"].includes(t)&&this.predictionCache.clear(),"PIECE_LOCKED"===t&&this.adaptDifficulty(s)}adaptDifficulty(e){const t=Math.min(10,Math.floor(e.score/1e4)+1);t!==this.difficultyLevel&&(this.difficultyLevel=t,this.logger.info(`Auto-adjusted difficulty to level ${t}`))}recordMetric(e,t){this.metrics=this.metrics||{},this.metrics[e]=this.metrics[e]||[],this.metrics[e].push({value:t,timestamp:Date.now()}),this.metrics[e].length>100&&(this.metrics[e]=this.metrics[e].slice(-100))}async healthCheck(){const e=this.predictionCache.size,t=this.getPerformanceMetrics(),s=[];return t.prediction_time?.avg>100&&s.push("High prediction latency"),e>800&&s.push("Cache size approaching limit"),{status:0===s.length?"healthy":"degraded",issues:s,metrics:t,cacheSize:e,difficultyLevel:this.difficultyLevel,aiModelLoaded:this.aiModelLoaded}}getPerformanceMetrics(){const e={};for(const[t,s]of Object.entries(this.metrics||{})){const i=s.slice(-50).map(e=>e.value);i.length>0&&(e[t]={count:i.length,avg:i.reduce((e,t)=>e+t,0)/i.length,min:Math.min(...i),max:Math.max(...i)})}return e}}class r{constructor(e,t="win95"){this.canvas=e,this.ctx=e.getContext("2d"),this.theme=t,this.blockSize=30,this.gridWidth=10,this.gridHeight=20,this.animationQueue=[],this.setupCanvas(),this.loadThemes()}setupCanvas(){this.canvas.width=this.gridWidth*this.blockSize,this.canvas.height=this.gridHeight*this.blockSize,this.ctx.imageSmoothingEnabled=!1}loadThemes(){this.themes={win95:{background:"#c0c0c0",gridBorder:"#808080",gridBackground:"#000000",blockColors:{I:"#00ffff",O:"#ffff00",T:"#800080",S:"#00ff00",Z:"#ff0000",J:"#0000ff",L:"#ffa500"},blockBorder:"#ffffff",blockShadow:"#404040",text:"#000000",panel:"#c0c0c0",panelBorder:"#808080"},dark:{background:"#2d2d30",gridBorder:"#3e3e42",gridBackground:"#1e1e1e",blockColors:{I:"#00d4ff",O:"#ffd700",T:"#9d4edd",S:"#06ffa5",Z:"#ff006e",J:"#3a86ff",L:"#ff8500"},blockBorder:"#ffffff",blockShadow:"#000000",text:"#ffffff",panel:"#2d2d30",panelBorder:"#3e3e42"}}}setTheme(e){this.theme=e,this.render()}render(e){this.clearCanvas(),e&&(this.renderGrid(e.grid),e.currentPiece&&(this.renderPiece(e.currentPiece),this.renderGhost(e.currentPiece,e.grid)),this.processAnimations())}clearCanvas(){const e=this.themes[this.theme];this.ctx.fillStyle=e.gridBackground,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}renderGrid(e){const t=this.themes[this.theme];for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++)0!==e[t][s]&&this.renderBlock(s,t,e[t][s]);this.ctx.strokeStyle=t.gridBorder,this.ctx.lineWidth=1;for(let e=0;e<=this.gridWidth;e++)this.ctx.beginPath(),this.ctx.moveTo(e*this.blockSize,0),this.ctx.lineTo(e*this.blockSize,this.canvas.height),this.ctx.stroke();for(let e=0;e<=this.gridHeight;e++)this.ctx.beginPath(),this.ctx.moveTo(0,e*this.blockSize),this.ctx.lineTo(this.canvas.width,e*this.blockSize),this.ctx.stroke()}renderPiece(e){if(!e||!e.shape)return;const t=e.shape;for(let s=0;s<t.length;s++)for(let i=0;i<t[s].length;i++)0!==t[s][i]&&this.renderBlock(e.x+i,e.y+s,e.type)}renderGhost(e,t){let s=e.y;for(;!this.wouldCollide(e,e.x,s+1,t);)s++;if(s===e.y)return;const i=e.shape;this.themes[this.theme],this.ctx.save(),this.ctx.globalAlpha=.3;for(let t=0;t<i.length;t++)for(let a=0;a<i[t].length;a++)0!==i[t][a]&&this.renderBlock(e.x+a,s+t,e.type);this.ctx.restore()}renderBlock(e,t,s){if(e<0||e>=this.gridWidth||t<0||t>=this.gridHeight)return;const i=this.themes[this.theme],a=i.blockColors[s]||i.blockColors.I,n=e*this.blockSize,r=t*this.blockSize;this.ctx.fillStyle=a,this.ctx.fillRect(n,r,this.blockSize,this.blockSize),"win95"===this.theme?(this.ctx.strokeStyle=i.blockBorder,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(n,r+this.blockSize),this.ctx.lineTo(n,r),this.ctx.lineTo(n+this.blockSize,r),this.ctx.stroke(),this.ctx.strokeStyle=i.blockShadow,this.ctx.beginPath(),this.ctx.moveTo(n+this.blockSize,r),this.ctx.lineTo(n+this.blockSize,r+this.blockSize),this.ctx.lineTo(n,r+this.blockSize),this.ctx.stroke()):(this.ctx.strokeStyle=i.blockBorder,this.ctx.lineWidth=1,this.ctx.strokeRect(n,r,this.blockSize,this.blockSize))}wouldCollide(e,t,s,i){const a=e.shape;for(let e=0;e<a.length;e++)for(let n=0;n<a[e].length;n++){if(0===a[e][n])continue;const r=t+n,o=s+e;if(r<0||r>=this.gridWidth||o>=this.gridHeight)return!0;if(!(o<0)&&0!==i[o][r])return!0}return!1}animateLineClear(e){e.forEach(e=>{this.animationQueue.push({type:"lineClear",y:e,progress:0,duration:300})})}animatePieceDrop(e){this.animationQueue.push({type:"pieceDrop",piece:{...e},progress:0,duration:150})}processAnimations(){Date.now(),this.animationQueue=this.animationQueue.filter(e=>(e.progress+=16,"lineClear"===e.type?this.renderLineClearAnimation(e):"pieceDrop"===e.type&&this.renderPieceDropAnimation(e),e.progress<e.duration))}renderLineClearAnimation(e){const t=1-e.progress/e.duration;this.ctx.save(),this.ctx.globalAlpha=t,this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,e.y*this.blockSize,this.canvas.width,this.blockSize),this.ctx.restore()}renderPieceDropAnimation(e){if(!e||!e.piece)return;const t=e.progress/e.duration,s=1-Math.pow(1-t,3);this.ctx.save(),this.ctx.globalAlpha=1-s,this.renderPiece(e.piece),this.ctx.restore()}renderUI(e,t){const s=t.getContext("2d"),i=this.themes[this.theme];s.fillStyle=i.panel,s.fillRect(0,0,t.width,t.height),this.renderPanel(s,10,10,180,120,"Score"),this.renderText(s,`Score: ${e.score}`,20,40),this.renderText(s,`Level: ${e.level}`,20,60),this.renderText(s,`Lines: ${e.lines}`,20,80),this.renderPanel(s,10,140,180,200,"Next"),this.renderNextPieces(s,e.nextPieces,20,170),this.renderPanel(s,10,350,180,100,"Controls"),this.renderText(s,"← → ↓ Move",20,380,"10px"),this.renderText(s,"↑ Rotate",20,395,"10px"),this.renderText(s,"Space Drop",20,410,"10px")}renderPanel(e,t,s,i,a,n){const r=this.themes[this.theme];e.fillStyle=r.panel,e.fillRect(t,s,i,a),"win95"===this.theme?(e.strokeStyle=r.panelBorder,e.lineWidth=2,e.strokeRect(t,s,i,a),e.fillStyle="#0000ff",e.fillRect(t+2,s+2,i-4,18),e.fillStyle="#ffffff",e.font='11px "MS Sans Serif"',e.fillText(n,t+6,s+14)):(e.strokeStyle=r.panelBorder,e.strokeRect(t,s,i,a),e.fillStyle=r.text,e.font="12px monospace",e.fillText(n,t+6,s+16))}renderText(e,t,s,i,a="12px"){const n=this.themes[this.theme];e.fillStyle=n.text,e.font=`${a} ${"win95"===this.theme?'"MS Sans Serif"':"monospace"}`,e.fillText(t,s,i)}renderNextPieces(e,t,s,i){t.slice(0,3).forEach((t,a)=>{const n=i+60*a;this.renderMiniPiece(e,t,s,n)})}renderMiniPiece(e,t,s,i){const a=12,n=this.themes[this.theme],r=n.blockColors[t.type];t.shape.forEach((t,o)=>{t.forEach((t,c)=>{if(0!==t){const t=s+c*a,h=i+o*a;e.fillStyle=r,e.fillRect(t,h,a,a),e.strokeStyle=n.blockBorder,e.strokeRect(t,h,a,a)}})})}}class o extends e{constructor(e={}){super({id:"ui-controller",name:"Tetris UI Controller",capabilities:["rendering","input-handling","theme-management","replay-ui"],...e}),this.renderer=null,this.currentTheme="win95",this.gameCanvas=null,this.uiCanvas=null,this.isRendering=!1,this.frameCount=0,this.fps=0,this.lastFrameTime=0,this.setupMessageHandlers()}async initialize(){await super.initialize(),this.logger.info("UI Controller Agent initialized"),await this.registerCapabilities(["rendering","input-handling","theme-management","replay-ui","animation-system","performance-monitoring"]),await this.initializeRenderer(),this.startPerformanceMonitoring()}setupMessageHandlers(){this.onMessage("RENDER_FRAME",this.handleRenderFrame.bind(this)),this.onMessage("UPDATE_DISPLAY",this.handleUpdateDisplay.bind(this)),this.onMessage("SET_THEME",this.handleSetTheme.bind(this)),this.onMessage("TOGGLE_THEME",this.handleToggleTheme.bind(this)),this.onMessage("HANDLE_INPUT",this.handleInput.bind(this)),this.onMessage("REGISTER_INPUT_HANDLER",this.handleRegisterInputHandler.bind(this)),this.onMessage("ANIMATE_LINE_CLEAR",this.handleAnimateLineClear.bind(this)),this.onMessage("ANIMATE_PIECE_DROP",this.handleAnimatePieceDrop.bind(this)),this.onMessage("SHOW_REPLAY_CONTROLS",this.handleShowReplayControls.bind(this)),this.onMessage("UPDATE_REPLAY_PROGRESS",this.handleUpdateReplayProgress.bind(this)),this.onMessage("GAME_STATE_UPDATE",this.handleGameStateUpdate.bind(this)),this.onMessage("SHOW_DIALOG",this.handleShowDialog.bind(this)),this.onMessage("HIDE_DIALOG",this.handleHideDialog.bind(this)),this.onMessage("UPDATE_UI_ELEMENT",this.handleUpdateUIElement.bind(this))}async initializeRenderer(){try{this.gameCanvas=document.getElementById("gameCanvas")||this.createCanvas("gameCanvas",300,600),this.uiCanvas=document.getElementById("uiCanvas")||this.createCanvas("uiCanvas",200,600),this.renderer=new r(this.gameCanvas,this.currentTheme),this.setupInputListeners(),this.logger.info("Renderer initialized successfully")}catch(e){throw this.logger.error("Failed to initialize renderer:",e),e}}createCanvas(e,t,s){const i=document.createElement("canvas");return i.id=e,i.width=t,i.height=s,i.style.border="2px inset #c0c0c0",(document.getElementById("gameContainer")||document.body).appendChild(i),i}setupInputListeners(){document.addEventListener("keydown",e=>{this.handleKeyboardInput(e)}),document.addEventListener("click",e=>{this.handleMouseInput(e)}),document.addEventListener("touchstart",e=>{this.handleTouchInput(e)}),window.addEventListener("resize",()=>{this.handleResize()})}async handleKeyboardInput(e){const t={type:"INPUT_EVENT",payload:{inputType:"keyboard",key:e.key,code:e.code,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,timestamp:Date.now()}};await this.sendMessage("game-engine",t),"F1"===e.key&&(await this.handleToggleTheme(),e.preventDefault())}async handleMouseInput(e){const t=e.target.getBoundingClientRect();e.clientX,t.left,e.clientY,t.top,e.button,e.target.id,Date.now(),e.target.classList.contains("game-button")&&await this.handleButtonClick(e.target)}async handleTouchInput(e){const t=e.touches[0];if(t){const e=t.target.getBoundingClientRect(),s={type:"INPUT_EVENT",payload:{inputType:"touch",x:t.clientX-e.left,y:t.clientY-e.top,target:t.target.id,timestamp:Date.now()}};await this.sendMessage("game-engine",s)}}async handleButtonClick(e){const t=e.dataset.action;switch(t){case"pause":await this.sendMessage("game-engine",{type:"PAUSE_GAME"});break;case"restart":await this.sendMessage("game-engine",{type:"RESTART_GAME"});break;case"theme-toggle":await this.handleToggleTheme();break;default:this.logger.warn(`Unknown button action: ${t}`)}}async handleRenderFrame(e){const t=performance.now();try{const{gameState:s,forceRender:i=!1}=e.payload;if(!this.isRendering||i){this.isRendering=!0,this.renderer.render(s),this.renderer.renderUI(s,this.uiCanvas),this.updateHTMLElements(s),this.isRendering=!1,this.frameCount++;const e=performance.now()-t;this.recordMetric("render_time",e),e>16&&this.logger.warn(`Slow frame: ${e.toFixed(2)}ms`)}return{success:!0,renderTime:performance.now()-t}}catch(e){return this.isRendering=!1,this.logger.error("Failed to render frame:",e),{success:!1,error:e.message}}}updateHTMLElements(e){this.updateElement("score",e.score?.toLocaleString()||"0"),this.updateElement("level",e.level?.toString()||"1"),this.updateElement("lines",e.lines?.toString()||"0"),this.updateElement("gameState",e.gameState||"unknown"),e.nextPieces&&this.updateNextPiecesDisplay(e.nextPieces),void 0!==e.aiConfidence&&this.updateElement("aiConfidence",`${Math.round(100*e.aiConfidence)}%`)}updateElement(e,t){const s=document.getElementById(e);s&&s.textContent!==t&&(s.textContent=t)}updateNextPiecesDisplay(e){const t=document.getElementById("nextPieces");t&&(t.innerHTML="",e.slice(0,3).forEach((e,s)=>{const i=document.createElement("canvas");i.width=80,i.height=60,i.className="next-piece-preview",this.renderMiniPiece(i,e),t.appendChild(i)}))}renderMiniPiece(e,t){const s=e.getContext("2d"),i=12,a=this.renderer.themes[this.currentTheme];s.clearRect(0,0,e.width,e.height),t.shape&&t.shape.forEach((e,n)=>{e.forEach((e,r)=>{if(0!==e){const e=r*i+10,o=n*i+10;s.fillStyle=a.blockColors[t.type]||a.blockColors.I,s.fillRect(e,o,i,i),s.strokeStyle=a.blockBorder,s.strokeRect(e,o,i,i)}})})}async handleSetTheme(e){try{const{theme:t}=e.payload;if(!["win95","dark"].includes(t))throw new Error(`Invalid theme: ${t}`);this.currentTheme=t,this.renderer.setTheme(t),document.body.className=`theme-${t}`;const s=document.getElementById("themeToggle");return s&&(s.textContent="win95"===t?"Dark Mode":"Win95 Mode"),this.logger.info(`Theme changed to: ${t}`),{success:!0,theme:this.currentTheme}}catch(e){return this.logger.error("Failed to set theme:",e),{success:!1,error:e.message}}}async handleToggleTheme(e={}){const t="win95"===this.currentTheme?"dark":"win95";return this.handleSetTheme({payload:{theme:t}})}async handleAnimateLineClear(e){try{const{lines:t}=e.payload;return this.renderer.animateLineClear(t),this.playSound("lineClear"),{success:!0}}catch(e){return this.logger.error("Failed to animate line clear:",e),{success:!1,error:e.message}}}async handleAnimatePieceDrop(e){try{const{piece:t}=e.payload;return this.renderer.animatePieceDrop(t),this.playSound("pieceDrop"),{success:!0}}catch(e){return this.logger.error("Failed to animate piece drop:",e),{success:!1,error:e.message}}}playSound(e){try{const t=document.getElementById(`sound-${e}`);t&&(t.currentTime=0,t.play().catch(()=>{}))}catch(e){}}async handleShowDialog(e){try{const{dialogId:t,content:s,buttons:i=[]}=e.payload,a=this.createDialog(t,s,i);return document.body.appendChild(a),a.className=`dialog theme-${this.currentTheme}`,{success:!0,dialogId:t}}catch(e){return this.logger.error("Failed to show dialog:",e),{success:!1,error:e.message}}}createDialog(e,t,s){const i=document.createElement("div");i.id=e,i.className="dialog-overlay";const a=document.createElement("div");a.className="dialog-box";const n=document.createElement("div");n.className="dialog-content",n.innerHTML=t;const r=document.createElement("div");return r.className="dialog-buttons",s.forEach(t=>{const s=document.createElement("button");s.textContent=t.text,s.className="dialog-button",s.onclick=()=>{t.action&&t.action(),this.hideDialog(e)},r.appendChild(s)}),a.appendChild(n),a.appendChild(r),i.appendChild(a),i}async handleHideDialog(e){const{dialogId:t}=e.payload;return this.hideDialog(t),{success:!0}}hideDialog(e){const t=document.getElementById(e);t&&t.remove()}async handleGameStateUpdate(e){const{eventType:t,gameState:s}=e.payload;switch(t){case"GAME_OVER":await this.showGameOverDialog(s);break;case"LEVEL_UP":await this.showLevelUpNotification(s.level);break;case"LINE_CLEAR":await this.handleAnimateLineClear({payload:{lines:s.lastLinesCleared}})}await this.handleRenderFrame({payload:{gameState:s}})}async showGameOverDialog(e){const t=`\n      <h2>Game Over!</h2>\n      <p>Final Score: ${e.score.toLocaleString()}</p>\n      <p>Level Reached: ${e.level}</p>\n      <p>Lines Cleared: ${e.lines}</p>\n    `,s=[{text:"Play Again",action:()=>this.sendMessage("game-engine",{type:"RESTART_GAME"})},{text:"View Replay",action:()=>this.sendMessage("replay-system",{type:"START_REPLAY"})}];await this.handleShowDialog({payload:{dialogId:"gameOverDialog",content:t,buttons:s}})}async showLevelUpNotification(e){const t=document.createElement("div");t.className="level-up-notification",t.textContent=`Level ${e}!`,t.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: #ffff00;\n      color: #000000;\n      padding: 20px;\n      border: 2px solid #000000;\n      font-size: 24px;\n      font-weight: bold;\n      z-index: 9999;\n      animation: fadeInOut 2s ease-in-out;\n    ",document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},2e3)}handleResize(){if(this.gameCanvas&&this.uiCanvas){const e=this.gameCanvas.parentElement;if(e){const t=e.clientWidth,s=Math.min(1,t/500);this.gameCanvas.style.transform=`scale(${s})`,this.uiCanvas.style.transform=`scale(${s})`}}}startPerformanceMonitoring(){setInterval(()=>{this.fps=this.frameCount,this.frameCount=0,this.updateElement("fps",`${this.fps} FPS`),this.fps<30&&this.logger.warn(`Low FPS detected: ${this.fps}`)},1e3)}recordMetric(e,t){this.metrics=this.metrics||{},this.metrics[e]=this.metrics[e]||[],this.metrics[e].push({value:t,timestamp:Date.now()}),this.metrics[e].length>100&&(this.metrics[e]=this.metrics[e].slice(-100))}async healthCheck(){const e=this.getPerformanceMetrics(),t=[];return this.fps<30&&t.push("Low frame rate"),e.render_time?.avg>16&&t.push("High render latency"),this.renderer||t.push("Renderer not initialized"),{status:0===t.length?"healthy":"degraded",issues:t,metrics:e,fps:this.fps,theme:this.currentTheme,canvasInitialized:!(!this.gameCanvas||!this.uiCanvas)}}getPerformanceMetrics(){const e={};for(const[t,s]of Object.entries(this.metrics||{})){const i=s.slice(-50).map(e=>e.value);i.length>0&&(e[t]={count:i.length,avg:i.reduce((e,t)=>e+t,0)/i.length,min:Math.min(...i),max:Math.max(...i)})}return e}async handleUpdateDisplay(e){const{displayType:t,data:s}=e.payload;switch(t){case"score":this.updateScoreDisplay(s);break;case"level":this.updateLevelDisplay(s);break;case"nextPiece":this.updateNextPieceDisplay(s);break;case"holdPiece":this.updateHoldPieceDisplay(s);break;default:this.logger.warn(`Unknown display type: ${t}`)}return{success:!0}}async handleInput(e){const{inputType:t,data:s}=e.payload;switch(t){case"keyboard":await this.handleKeyboardInput(s);break;case"mouse":await this.handleMouseInput(s);break;case"touch":await this.handleTouchInput(s);break;default:this.logger.warn(`Unknown input type: ${t}`)}return{success:!0}}async handleRegisterInputHandler(e){const{handlerType:t,handler:s}=e.payload;return this.inputHandlers||(this.inputHandlers=new Map),this.inputHandlers.set(t,s),{success:!0}}async handleShowReplayControls(e){const{show:t}=e.payload;return t?this.showReplayControls():this.hideReplayControls(),{success:!0}}async handleUpdateReplayProgress(e){const{progress:t,currentFrame:s,totalFrames:i}=e.payload;return this.updateReplayProgress(t,s,i),{success:!0}}updateScoreDisplay(e){console.log(`Score: ${e}`)}updateLevelDisplay(e){console.log(`Level: ${e}`)}updateNextPieceDisplay(e){console.log(`Next piece: ${e}`)}updateHoldPieceDisplay(e){console.log(`Hold piece: ${e}`)}showReplayControls(){console.log("Showing replay controls")}hideReplayControls(){console.log("Hiding replay controls")}updateReplayProgress(e,t,s){console.log(`Replay progress: ${e}% (${t}/${s})`)}async handleUpdateUIElement(e){const{elementId:t,property:s,value:i}=e.payload;return console.log(`Updating UI element ${t}: ${s} = ${i}`),{success:!0}}async shutdown(){this.logger.info("Shutting down UI Controller Agent"),this.isRendering=!1,document.removeEventListener("keydown",this.handleKeyboardInput),document.removeEventListener("click",this.handleMouseInput),document.removeEventListener("touchstart",this.handleTouchInput),window.removeEventListener("resize",this.handleResize),await super.shutdown()}}class c extends t{constructor(e={}){super({id:"tetris-orchestrator",name:"Tetris Game Orchestrator",...e}),this.config=e,this.agents=new Map,this.messageQueue=[],this.circuitBreakers=new Map,this.performanceMetrics=new Map,this.gameLoop=null,this.isRunning=!1,this.setupMessageRouting(),this.setupCircuitBreakers()}async initialize(){await super.initialize(),this.logger.info("Tetris Orchestrator initializing..."),await this.initializeAgents(),await this.setupCommunication(),this.startHealthMonitoring(),this.logger.info("Tetris Orchestrator initialized successfully")}async initializeAgents(){try{const e=new a({orchestratorId:this.id,logLevel:this.config.logLevel||"info"});await e.initialize(),this.agents.set("game-engine",e);const t=new n({orchestratorId:this.id,logLevel:this.config.logLevel||"info"});await t.initialize(),this.agents.set("ai-predictor",t);{const e=new o({orchestratorId:this.id,logLevel:this.config.logLevel||"info"});await e.initialize(),this.agents.set("ui-controller",e)}this.logger.info("All agents initialized successfully")}catch(e){throw this.logger.error("Failed to initialize agents:",e),e}}async setupCommunication(){await this.routeMessage("ui-controller","game-engine",{type:"SUBSCRIBE_STATE_UPDATES",payload:{agentId:"ui-controller"}}),await this.routeMessage("ai-predictor","game-engine",{type:"SUBSCRIBE_STATE_UPDATES",payload:{agentId:"ai-predictor"}}),this.logger.info("Inter-agent communication setup complete")}setupMessageRouting(){this.routingTable={START_GAME:"game-engine",PAUSE_GAME:"game-engine",RESTART_GAME:"game-engine",MOVE_PIECE:"game-engine",ROTATE_PIECE:"game-engine",DROP_PIECE:"game-engine",PREDICT_BEST_MOVE:"ai-predictor",ANALYZE_BOARD:"ai-predictor",SET_DIFFICULTY:"ai-predictor",RENDER_FRAME:"ui-controller",SET_THEME:"ui-controller",SHOW_DIALOG:"ui-controller",ANIMATE_LINE_CLEAR:"ui-controller",INPUT_EVENT:"orchestrator"}}setupCircuitBreakers(){const e={threshold:5,timeout:3e4,monitoringPeriod:6e4};for(const t of["game-engine","ai-predictor","ui-controller"])this.circuitBreakers.set(t,{...e,failures:0,state:"CLOSED",lastFailure:0,nextAttempt:0})}async routeMessage(e,t,s){const i=performance.now();try{if(!this.isCircuitClosed(t))throw new Error(`Circuit breaker open for agent: ${t}`);const a={...s,metadata:{fromAgent:e,toAgent:t,timestamp:Date.now(),routingId:this.generateRoutingId()}},n=this.agents.get(t);if(!n)throw new Error(`Agent not found: ${t}`);const r=await n.handleMessage(a);this.recordSuccess(t);const o=performance.now()-i;return this.recordMetric("message_latency",o,{fromAgent:e,toAgent:t}),o>10&&this.logger.warn(`Slow message routing: ${e} → ${t}: ${o.toFixed(2)}ms`),r}catch(i){return this.recordFailure(t,i),this.logger.error(`Message routing failed: ${e} → ${t}:`,i),this.handleRoutingFailure(e,t,s,i)}}async handleInputEvent(e){try{const{inputType:t,key:s,x:i,y:a}=e.payload;return"keyboard"===t?this.handleKeyboardInput(s):"mouse"===t?this.handleMouseInput(i,a):"touch"===t?this.handleTouchInput(i,a):{success:!1,error:"Unknown input type"}}catch(e){return this.logger.error("Failed to handle input event:",e),{success:!1,error:e.message}}}async handleKeyboardInput(e){const t={ArrowLeft:{type:"MOVE_PIECE",payload:{direction:"left"}},ArrowRight:{type:"MOVE_PIECE",payload:{direction:"right"}},ArrowDown:{type:"MOVE_PIECE",payload:{direction:"down"}},ArrowUp:{type:"ROTATE_PIECE",payload:{}}," ":{type:"DROP_PIECE",payload:{}},Escape:{type:"PAUSE_GAME",payload:{}},p:{type:"PAUSE_GAME",payload:{}},r:{type:"RESTART_GAME",payload:{}}}[e];if(t){const e=this.routingTable[t.type];if(e)return this.routeMessage("orchestrator",e,t)}return{success:!1,error:"Unmapped key"}}async handleMouseInput(e,t){return this.routeMessage("orchestrator","ui-controller",{type:"HANDLE_MOUSE_INPUT",payload:{x:e,y:t}})}async handleTouchInput(e,t){return this.handleMouseInput(e,t)}async startGame(){try{this.logger.info("Starting new game...");const e=await this.routeMessage("orchestrator","game-engine",{type:"START_GAME",payload:{}});if(!e.success)throw new Error("Failed to start game engine");return await this.routeMessage("orchestrator","ui-controller",{type:"RENDER_FRAME",payload:{gameState:e.gameState,forceRender:!0}}),this.startGameLoop(),this.isRunning=!0,this.logger.info("Game started successfully"),{success:!0}}catch(e){return this.logger.error("Failed to start game:",e),{success:!1,error:e.message}}}startGameLoop(){let e=performance.now();const t=async s=>{if(!this.isRunning)return;const i=s-e;e=s;try{const e=this.agents.get("game-engine");e&&await e.update(i);const t=await this.routeMessage("orchestrator","game-engine",{type:"GET_GAME_STATE",payload:{}});t.success&&(await this.routeMessage("orchestrator","ui-controller",{type:"RENDER_FRAME",payload:{gameState:t.gameState}}),t.gameState.currentPiece&&Math.random()<.1&&this.getAISuggestion(t.gameState))}catch(e){this.logger.error("Game loop error:",e)}this.gameLoop=requestAnimationFrame(t)};this.gameLoop=requestAnimationFrame(t)}async getAISuggestion(e){try{const t=await this.routeMessage("orchestrator","ai-predictor",{type:"PREDICT_BEST_MOVE",payload:{piece:e.currentPiece,grid:e.grid,nextPieces:e.nextPieces}});t.success&&await this.routeMessage("orchestrator","ui-controller",{type:"SHOW_AI_SUGGESTION",payload:{prediction:t.prediction}})}catch(e){this.logger.warn("Failed to get AI suggestion:",e)}}stopGame(){this.isRunning=!1,this.gameLoop&&(cancelAnimationFrame(this.gameLoop),this.gameLoop=null),this.logger.info("Game stopped")}isCircuitClosed(e){const t=this.circuitBreakers.get(e);if(!t)return!0;if("OPEN"===t.state){if(!(Date.now()>t.nextAttempt))return!1;t.state="HALF_OPEN",this.logger.info(`Circuit breaker for ${e} moved to HALF_OPEN`)}return!0}recordSuccess(e){const t=this.circuitBreakers.get(e);t&&(t.failures=0,"HALF_OPEN"===t.state&&(t.state="CLOSED",this.logger.info(`Circuit breaker for ${e} closed`)))}recordFailure(e,t){const s=this.circuitBreakers.get(e);s&&(s.failures++,s.lastFailure=Date.now(),s.failures>=s.threshold&&(s.state="OPEN",s.nextAttempt=Date.now()+s.timeout,this.logger.error(`Circuit breaker for ${e} opened after ${s.failures} failures`)))}async handleRoutingFailure(e,t,s,i){return"ai-predictor"===t?{success:!1,error:"AI service unavailable",fallback:!0}:"ui-controller"===t?(this.logger.error("UI Controller unavailable, game continues without rendering"),{success:!1,error:"UI service unavailable",fallback:!0}):"game-engine"===t?(this.logger.error("Game Engine unavailable, stopping game"),this.stopGame(),{success:!1,error:"Game engine unavailable",critical:!0}):{success:!1,error:i.message}}recordMetric(e,t,s={}){const i=`${e}:${JSON.stringify(s)}`;this.performanceMetrics.has(i)||this.performanceMetrics.set(i,[]);const a=this.performanceMetrics.get(i);a.push({value:t,timestamp:Date.now()}),a.length>1e3&&a.splice(0,500)}generateRoutingId(){return`route_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}startHealthMonitoring(){setInterval(async()=>{await this.performHealthChecks()},3e4)}async performHealthChecks(){const e={};for(const[t,s]of this.agents)try{const i=await s.healthCheck();e[t]=i,"healthy"!==i.status&&this.logger.warn(`Agent ${t} health check failed:`,i)}catch(s){e[t]={status:"error",error:s.message},this.logger.error(`Health check failed for ${t}:`,s)}const t=Object.entries(e).filter(([e,t])=>"healthy"!==t.status).map(([e,t])=>e);return t.length>0&&this.logger.warn(`Unhealthy agents detected: ${t.join(", ")}`),e}getPerformanceReport(){const e={timestamp:Date.now(),agents:{},circuitBreakers:{},metrics:{}};for(const[t,s]of this.agents)e.agents[t]={status:"unknown"};for(const[t,s]of this.circuitBreakers)e.circuitBreakers[t]={state:s.state,failures:s.failures,lastFailure:s.lastFailure};for(const[t,s]of this.performanceMetrics){const i=s.slice(-100).map(e=>e.value);i.length>0&&(e.metrics[t]={count:i.length,avg:i.reduce((e,t)=>e+t,0)/i.length,min:Math.min(...i),max:Math.max(...i),p95:this.percentile(i,.95)})}return e}percentile(e,t){const s=[...e].sort((e,t)=>e-t);return s[Math.ceil(s.length*t)-1]||0}async shutdown(){this.logger.info("Shutting down Tetris Orchestrator..."),this.stopGame();for(const[e,t]of this.agents)try{await t.shutdown(),this.logger.info(`Agent ${e} shut down successfully`)}catch(t){this.logger.error(`Failed to shutdown agent ${e}:`,t)}this.agents.clear(),this.circuitBreakers.clear(),this.performanceMetrics.clear(),await super.shutdown(),this.logger.info("Tetris Orchestrator shut down complete")}}class h{constructor(){this.inputs=[],this.states=[],this.annotations=[],this.startTime=null,this.isRecording=!1,this.isPlaying=!1,this.playbackIndex=0,this.playbackSpeed=1}startRecording(){this.reset(),this.isRecording=!0,this.startTime=Date.now()}stopRecording(){this.isRecording=!1}reset(){this.inputs=[],this.states=[],this.annotations=[],this.startTime=null,this.isRecording=!1,this.isPlaying=!1,this.playbackIndex=0}recordInput(e,t){if(!this.isRecording)return;const s=t-this.startTime;this.inputs.push({action:e,timestamp:s,frameIndex:this.states.length})}recordState(e,t){if(!this.isRecording)return;const s=t-this.startTime,i=this.compressState(e);this.states.push({state:i,timestamp:s,frameIndex:this.states.length}),this.analyzeStateForAnnotations(e,s)}compressState(e){return{grid:this.compressGrid(e.grid),currentPiece:e.currentPiece?{type:e.currentPiece.type,x:e.currentPiece.x,y:e.currentPiece.y,rotation:e.currentPiece.rotation}:null,score:e.score,level:e.level,lines:e.lines,gameState:e.gameState}}compressGrid(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s],a=[];let n=i[0],r=1;for(let e=1;e<i.length;e++)i[e]===n?r++:(a.push([n,r]),n=i[e],r=1);a.push([n,r]),t.push(a)}return t}decompressGrid(e){const t=[];for(let s=0;s<e.length;s++){const i=[],a=e[s];for(const[e,t]of a)for(let s=0;s<t;s++)i.push(e);t.push(i)}return t}analyzeStateForAnnotations(e,t){const s=[],i=this.findFullLines(e.grid);i.length>0&&s.push({type:"lineClear",lines:i.length,message:`${i.length} line${i.length>1?"s":""} cleared!`,importance:i.length>=4?"high":"medium"});const a=this.calculateDangerLevel(e.grid);a>.8&&s.push({type:"danger",level:a,message:"Critical situation! Grid is nearly full.",importance:"high"});const n=this.analyzeMoveQuality(e);n.score>.9&&s.push({type:"goodMove",score:n.score,message:n.reason,importance:"medium"}),s.length>0&&this.annotations.push({timestamp:t,frameIndex:this.states.length-1,annotations:s})}findFullLines(e){const t=[];for(let s=0;s<e.length;s++)e[s].every(e=>0!==e)&&t.push(s);return t}calculateDangerLevel(e){let t=0,s=0;for(let i=0;i<4;i++)for(let a=0;a<e[i].length;a++)0!==e[i][a]&&t++,s++;return t/s}analyzeMoveQuality(e){const t=e.grid,s=this.countHoles(t),i=this.getMaxHeight(t);let a="Good placement";return 0===s&&(a="No holes created"),i<10&&(a="Keeping height low"),{score:1/(1+.5*s+.1*i+.2*this.getBumpiness(t)),reason:a}}countHoles(e){let t=0;for(let s=0;s<10;s++){let i=!1;for(let a=0;a<20;a++)0!==e[a][s]?i=!0:i&&t++}return t}getMaxHeight(e){for(let t=0;t<20;t++)if(e[t].some(e=>0!==e))return 20-t;return 0}getBumpiness(e){const t=[];for(let s=0;s<10;s++){let i=0;for(let t=0;t<20;t++)if(0!==e[t][s]){i=20-t;break}t.push(i)}let s=0;for(let e=0;e<t.length-1;e++)s+=Math.abs(t[e]-t[e+1]);return s}startPlayback(e,t=1){0!==this.states.length&&(this.isPlaying=!0,this.playbackIndex=0,this.playbackSpeed=t,this.playbackLoop(e))}playbackLoop(e){if(!this.isPlaying||this.playbackIndex>=this.states.length)return void(this.isPlaying=!1);const t=this.states[this.playbackIndex],s={...t.state,grid:this.decompressGrid(t.state.grid)};e(s),this.showAnnotationsForFrame(this.playbackIndex);const i=this.states[this.playbackIndex+1],a=i?(i.timestamp-t.timestamp)/this.playbackSpeed:100;this.playbackIndex++,setTimeout(()=>this.playbackLoop(e),Math.max(16,a))}showAnnotationsForFrame(e){this.annotations.filter(t=>t.frameIndex===e).forEach(e=>{this.displayAnnotation(e)})}displayAnnotation(e){const t=document.createElement("div");t.className=`annotation annotation-${e.annotations[0].importance}`,t.textContent=e.annotations[0].message,t.style.position="absolute",t.style.top="50px",t.style.right="20px",t.style.padding="8px 12px",t.style.borderRadius="4px",t.style.backgroundColor=this.getAnnotationColor(e.annotations[0].importance),t.style.color="white",t.style.fontSize="12px",t.style.zIndex="1000",document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},3e3)}getAnnotationColor(e){switch(e){case"high":return"#ff4444";case"medium":return"#ffaa00";case"low":return"#44aa44";default:return"#666666"}}pausePlayback(){this.isPlaying=!1}resumePlayback(e){!this.isPlaying&&this.playbackIndex<this.states.length&&(this.isPlaying=!0,this.playbackLoop(e))}setPlaybackSpeed(e){this.playbackSpeed=Math.max(.1,Math.min(5,e))}seekToFrame(e){this.playbackIndex=Math.max(0,Math.min(e,this.states.length-1))}seekToTime(e){const t=this.states.findIndex(t=>t.timestamp>=e);-1!==t&&this.seekToFrame(t)}exportReplay(){return{version:"1.0",startTime:this.startTime,duration:this.states.length>0?this.states[this.states.length-1].timestamp:0,inputs:this.inputs,states:this.states,annotations:this.annotations,metadata:{gameVersion:"1.0",exportTime:Date.now()}}}importReplay(e){if("1.0"!==e.version)throw new Error("Unsupported replay version");this.reset(),this.startTime=e.startTime,this.inputs=e.inputs,this.states=e.states,this.annotations=e.annotations}getReplayData(){return this.exportReplay()}hasReplay(){return this.states.length>0}finalize(){this.stopRecording();const e=this.generateSummary();return this.saveToLocalStorage(),e}generateSummary(){if(0===this.states.length)return null;const e=this.states[this.states.length-1].state,t=this.states[this.states.length-1].timestamp;return{finalScore:e.score,finalLevel:e.level,totalLines:e.lines,duration:t,totalInputs:this.inputs.length,annotationCount:this.annotations.length,averageAPM:this.inputs.length/(t/1e3)*60}}saveToLocalStorage(){try{const e=this.exportReplay(),t=`tetris-replay-${Date.now()}`;return localStorage.setItem(t,JSON.stringify(e)),this.cleanupOldReplays(),t}catch(e){return console.warn("Failed to save replay:",e),null}}cleanupOldReplays(){const e=Object.keys(localStorage).filter(e=>e.startsWith("tetris-replay-"));e.length>10&&e.sort().slice(0,e.length-10).forEach(e=>{localStorage.removeItem(e)})}}class l{constructor(e,t){this.gameEngine=new s,this.renderer=new r(e),this.uiCanvas=t,this.inputHandler=new g,this.replaySystem=new h,this.isRunning=!1,this.lastTime=0,this.frameCount=0,this.fps=0,this.setupEventListeners(),this.setupGameLoop()}setupEventListeners(){document.addEventListener("keydown",e=>{this.handleKeyPress(e.key)})}handleKeyPress(e){if("playing"!==this.gameEngine.gameState)return;const t=this.inputHandler.mapKeyToAction(e);if(t)switch(this.replaySystem.recordInput(t,Date.now()),t.type){case"move":this.gameEngine.movePiece(t.direction);break;case"rotate":this.gameEngine.rotatePiece();break;case"drop":this.hardDrop();break;case"pause":this.togglePause()}}hardDrop(){let e=0;for(;this.gameEngine.movePiece("down");)e++;this.gameEngine.score+=2*e,this.renderer.animatePieceDrop(this.gameEngine.currentPiece)}toggleTheme(){const e=this.renderer.theme,t="win95"===e?"dark":"win95";this.renderer.setTheme(t),document.body.classList.remove(`theme-${e}`),document.body.classList.add(`theme-${t}`),"dark"===t?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme");const s=document.getElementById("themeToggle");s&&(s.textContent="win95"===t?"Dark Mode":"Win95 Mode")}togglePause(){const e=document.getElementById("pauseBtn");"playing"===this.gameEngine.gameState?(this.gameEngine.gameState="paused",this.isRunning=!1,e&&(e.textContent="Resume")):"paused"===this.gameEngine.gameState&&(this.gameEngine.gameState="playing",this.isRunning=!0,e&&(e.textContent="Pause"),this.gameLoop())}restart(){this.gameEngine=new s,this.replaySystem.reset(),this.start()}start(){this.gameEngine.spawnNewPiece(),this.isRunning=!0,this.lastTime=performance.now(),this.gameLoop()}setupGameLoop(){setInterval(()=>{this.fps=this.frameCount,this.frameCount=0,this.updatePerformanceDisplay()},1e3)}gameLoop(e=performance.now()){if(!this.isRunning)return;const t=e-this.lastTime;this.lastTime=e,this.frameCount++,this.update(t),this.render(),requestAnimationFrame(e=>this.gameLoop(e))}update(e){this.gameEngine.update(e),this.replaySystem.recordState(this.gameEngine.getState(),Date.now()),"gameOver"===this.gameEngine.gameState&&this.handleGameOver()}render(){const e=this.gameEngine.getState();this.renderer.render(e),this.renderer.renderUI(e,this.uiCanvas),this.updateUIElements(e)}updateUIElements(e){const t=document.getElementById("score");t&&(t.textContent=e.score.toLocaleString());const s=document.getElementById("level");s&&(s.textContent=e.level);const i=document.getElementById("lines");i&&(i.textContent=e.lines);const a=document.getElementById("gameState");a&&(a.textContent=e.gameState)}updatePerformanceDisplay(){const e=document.getElementById("fps");e&&(e.textContent=`${this.fps} FPS`)}handleGameOver(){this.isRunning=!1,this.saveHighScore(),this.showGameOverDialog(),this.replaySystem.finalize()}saveHighScore(){const e=this.gameEngine.score,t=this.getHighScores();t.push({score:e,level:this.gameEngine.level,lines:this.gameEngine.lines,date:(new Date).toISOString(),replay:this.replaySystem.getReplayData()}),t.sort((e,t)=>t.score-e.score);const s=t.slice(0,10);localStorage.setItem("tetris-highscores",JSON.stringify(s))}getHighScores(){try{return JSON.parse(localStorage.getItem("tetris-highscores")||"[]")}catch{return[]}}showGameOverDialog(){const e=document.getElementById("gameOverDialog");if(e){const t=document.getElementById("finalScore");t&&(t.textContent=this.gameEngine.score.toLocaleString()),e.style.display="block"}}startReplay(){this.replaySystem.hasReplay()&&(this.isRunning=!1,this.gameEngine.gameState="replay",this.replaySystem.startPlayback(e=>{this.renderer.render(e)}))}saveReplay(){const e=`replay_${Date.now()}`,t=this.replaySystem.getReplayData();console.log(`Replay saved: ${e}`,t),alert("Replay saved successfully!")}async getAISuggestion(){if(!this.gameEngine.currentPiece)return null;try{const e=this.getAIAgent();return await e.predictBestMove(this.gameEngine.currentPiece,this.gameEngine.grid)}catch(e){return console.warn("AI suggestion failed:",e),null}}getAIAgent(){return{predictBestMove:async(e,t)=>({x:4,y:0,rotation:0,confidence:.85,reasoning:"The AI recommends placing this piece in the center to maintain structural integrity and maximize future clearing potential."})}}}class g{constructor(){this.keyMappings={ArrowLeft:{type:"move",direction:"left"},ArrowRight:{type:"move",direction:"right"},ArrowDown:{type:"move",direction:"down"},ArrowUp:{type:"rotate"}," ":{type:"drop"},Escape:{type:"pause"},p:{type:"pause"},P:{type:"pause"}},this.lastInputTime=0,this.inputDelay=50}mapKeyToAction(e){const t=Date.now();return t-this.lastInputTime<this.inputDelay?null:(this.lastInputTime=t,this.keyMappings[e]||null)}setKeyMapping(e,t){this.keyMappings[e]=t}}class d{constructor(){this.orchestrator=null,this.gameController=null,this.isInitialized=!1}async initialize(){try{console.log("🎮 Initializing KIRO Tetris AI..."),this.orchestrator=new c({logLevel:"info"}),await this.orchestrator.initialize(),console.log("✅ Strands orchestrator initialized"),await this.initializeBrowserGame(),this.isInitialized=!0,console.log("🚀 KIRO Tetris AI initialized successfully!")}catch(e){throw console.error("❌ Failed to initialize KIRO Tetris AI:",e),e}}async loadEnvironment(){const e=process.env.CLOUD_PROVIDER||"aws";try{(await Promise.resolve().then(function(){var e=new Error("Cannot find module 'dotenv'");throw e.code="MODULE_NOT_FOUND",e})).default.config({path:`.env.${e}`}),console.log(`📋 Loaded ${e.toUpperCase()} configuration`)}catch(t){console.warn(`⚠️  Could not load .env.${e}, using system environment`)}this.validateEnvironment()}validateEnvironment(){const e=["NODE_ENV"].filter(e=>!process.env[e]);e.length>0&&console.warn(`⚠️  Missing environment variables: ${e.join(", ")}`)}async initializeBrowserGame(){"loading"===document.readyState&&await new Promise(e=>{document.addEventListener("DOMContentLoaded",e)});const e=this.createGameCanvas(),t=this.createUICanvas();this.gameController=new l(e,t),await this.connectGameToOrchestrator(),this.setupUIHandlers(),console.log("🎮 Browser game initialized")}createGameCanvas(){let e=document.getElementById("gameCanvas");return e||(e=document.createElement("canvas"),e.id="gameCanvas",e.width=300,e.height=600,e.style.border="2px inset #c0c0c0",(document.getElementById("gameContainer")||document.body).appendChild(e)),e}createUICanvas(){let e=document.getElementById("uiCanvas");return e||(e=document.createElement("canvas"),e.id="uiCanvas",e.width=200,e.height=600,e.style.border="2px inset #c0c0c0",(document.getElementById("gameContainer")||document.body).appendChild(e)),e}async connectGameToOrchestrator(){this.gameController.onGameEvent=async e=>{this.orchestrator&&await this.orchestrator.handleInputEvent({payload:e})}}setupUIHandlers(){const e=document.getElementById("themeToggle");e&&e.addEventListener("click",()=>{this.gameController.toggleTheme()});const t=document.getElementById("startBtn");t&&t.addEventListener("click",()=>{this.startGame()});const s=document.getElementById("pauseBtn");s&&s.addEventListener("click",()=>{this.gameController.togglePause()});const i=document.getElementById("restartBtn");i&&i.addEventListener("click",()=>{this.gameController.restart()});const a=document.getElementById("replayBtn");a&&a.addEventListener("click",()=>{this.gameController.startReplay()});const n=document.getElementById("saveReplayBtn");n&&n.addEventListener("click",()=>{this.gameController.saveReplay()});const r=document.getElementById("aiHintBtn");r&&r.addEventListener("click",async()=>{await this.showAIHint()});const o=document.getElementById("aiToggleBtn");o&&o.addEventListener("click",()=>{this.toggleAI()})}async showAIHint(){try{const e=await this.getAISuggestion();if(e){const t=document.getElementById("aiSuggestionDialog"),s=document.getElementById("aiSuggestionText"),i=document.getElementById("aiSuggestionConfidence");s&&(s.textContent=e.reasoning||"AI suggests this move"),i&&(i.textContent=`${Math.round(100*e.confidence)}%`),t&&(t.style.display="flex")}}catch(e){console.error("Failed to get AI hint:",e),alert("AI hint is not available at the moment")}}toggleAI(){if(this.gameController){this.gameController.aiEnabled=!this.gameController.aiEnabled;const e=document.getElementById("aiToggleBtn");e&&(e.textContent=this.gameController.aiEnabled?"Disable AI":"Enable AI"),console.log("AI "+(this.gameController.aiEnabled?"enabled":"disabled"))}}async getAISuggestion(){return this.gameController?await this.gameController.getAISuggestion():null}async initializeServer(){const e=(await Promise.resolve().then(function(){var e=new Error("Cannot find module 'express'");throw e.code="MODULE_NOT_FOUND",e})).default,t=(await Promise.resolve().then(function(){var e=new Error("Cannot find module 'cors'");throw e.code="MODULE_NOT_FOUND",e})).default,s=(await Promise.resolve().then(function(){var e=new Error("Cannot find module 'helmet'");throw e.code="MODULE_NOT_FOUND",e})).default,i=e(),a=process.env.PORT||3e3;i.use(s({contentSecurityPolicy:void 0})),i.use(t({origin:process.env.CORS_ORIGINS?.split(",")||["http://localhost:3000"],credentials:!0})),i.use(e.json({limit:"10mb"})),i.use(e.static("public")),i.use("/src",e.static("src")),this.setupAPIRoutes(i),this.server=i.listen(a,()=>{console.log(`🌐 Server running on port ${a}`),console.log("Server address:",this.server.address())}),this.server.on("error",e=>{console.error("Server error:",e),process.exit(1)}),this.server.on("listening",()=>{console.log("Server is listening")})}setupAPIRoutes(e){e.get("/api/health",async(e,t)=>{try{const e=await this.orchestrator.performHealthChecks();t.json({status:"healthy",timestamp:Date.now(),agents:e})}catch(e){t.status(500).json({status:"unhealthy",error:e.message})}}),e.post("/api/game/start",async(e,t)=>{try{const e=await this.orchestrator.startGame();t.json(e)}catch(e){t.status(500).json({success:!1,error:e.message})}}),e.post("/api/game/move",async(e,t)=>{try{const{direction:s}=e.body,i=await this.orchestrator.routeMessage("api","game-engine",{type:"MOVE_PIECE",payload:{direction:s}});t.json(i)}catch(e){t.status(500).json({success:!1,error:e.message})}}),e.post("/api/ai/predict",async(e,t)=>{try{const{piece:s,grid:i,nextPieces:a}=e.body,n=await this.orchestrator.routeMessage("api","ai-predictor",{type:"PREDICT_BEST_MOVE",payload:{piece:s,grid:i,nextPieces:a}});t.json(n)}catch(e){t.status(500).json({success:!1,error:e.message})}}),e.get("/api/metrics",async(e,t)=>{try{const e=this.orchestrator.getPerformanceReport();t.json(e)}catch(e){t.status(500).json({success:!1,error:e.message})}})}async startGame(){if(!this.isInitialized)throw new Error("App not initialized");try{await this.orchestrator.startGame(),this.gameController&&this.gameController.start(),console.log("🎮 Game started!")}catch(e){throw console.error("❌ Failed to start game:",e),e}}async shutdown(){console.log("🛑 Shutting down KIRO Tetris AI..."),this.orchestrator&&await this.orchestrator.shutdown(),console.log("✅ Shutdown complete")}}async function u(){const e=new d;try{await e.initialize(),process.on("SIGINT",async()=>{console.log("\n🛑 Received SIGINT, shutting down gracefully..."),await e.shutdown(),process.exit(0)}),process.on("SIGTERM",async()=>{console.log("\n🛑 Received SIGTERM, shutting down gracefully..."),await e.shutdown(),process.exit(0)}),setTimeout(()=>{e.startGame().catch(console.error)},1e3)}catch(e){console.error("💥 Fatal error:",e),process.exit(1)}}export{d as TetrisApp,u as main};